     1                                  BOOT_LOAD equ 0x7C00		;ÉuÅ[ÉgÉvÉçÉOÉâÉÄÇÃÉçÅ[Éhà íu
     2                                  
     3                                  ORG BOOT_LOAD			;ÉçÅ[ÉhÉAÉhÉåÉXÇÉAÉZÉìÉuÉâÇ…éwé¶ (1ìxÇµÇ©éwé¶Ç≈Ç´Ç»Ç¢)
     4                                  
     5                                  ;------------------------
     6                                  ;ÅyÉ}ÉNÉçÅz
     7                                  ;------------------------
     8                                  %include "..\include\macro.s"
     1                              <1> %macro cdecl 1-*.nolist
     2                              <1> 
     3                              <1>         %rep %0 - 1
     4                              <1>             push %{-1:-1}
     5                              <1>             %rotate -1
     6                              <1>         %endrep
     7                              <1>         %rotate -1
     8                              <1>         call %1
     9                              <1> 
    10                              <1>     %if 1 < %0
    11                              <1>         add sp,(__BITS__ >> 3) * (%0 - 1)
    12                              <1>     %endif
    13                              <1> 
    14                              <1> %endmacro
     9                                  
    10                                  ;****************************************************
    11                                  ;ÅyÉGÉìÉgÉäÉ|ÉCÉìÉgÅz
    12                                  ;****************************************************
    13                                  
    14                                  entry:
    15                                  
    16                                  
    17                                  ;----------------------------
    18                                  ;ÅyBPB(BIOS Parameter Block)Åz
    19                                  ;----------------------------
    20 00000000 EB58                    jmp	ipl		;IPLÇ÷ÉWÉÉÉìÉv
    21 00000002 90<rept>                times 90 - ($ - $$) db 0x90
    22                                  
    23                                  
    24                                  ;----------------------------
    25                                  ;ÅyIPL(Initial Program Loader)Åz
    26                                  ;----------------------------
    27                                  ipl:
    28 0000005A FA                      	cli			;äÑÇËçûÇ›èàóùÇ…ç°ÇÕëŒâûÇµÇƒÇ¢Ç»Ç¢ÇÃÇ≈ÅAäÑÇËçûÇ›èàóùÇã÷é~Ç…Ç∑ÇÈ
    29                                  	
    30 0000005B B80000                  	mov ax,0x0000		;AX = 0x0000
    31 0000005E 8ED8                    	mov ds,ax		;DS = 0x0000
    32 00000060 8EC0                    	mov es,ax		;ES = 0x0000
    33 00000062 8ED0                    	mov ss,ax		;SS = 0x0000
    34 00000064 BC007C                  	mov sp,BOOT_LOAD	;SP = 0x7C00
    35                                  
    36 00000067 FB                      	sti			;äÑÇËçûÇ›ãñâ¬
    37                                  
    38 00000068 8816[BA00]              	mov [BOOT.DRIVE],dl	;ÉuÅ[ÉgÉhÉâÉCÉuÇï€ë∂
    39                                  	
    40                                  	;----------------
    41                                  	;ï∂éöóÒÇï\é¶
    42                                  	;----------------
    43 0000006C 68[9800]E84A0083C4-     	cdecl puts,.s0		;puts(.s0)
    43 00000074 02                 
    44                                  	
    45                                  	;****************************************************
    46                                  	;ÅyäOïîãLâØëïíuÇ©ÇÁ2î‘ñ⁄ÇÃÉZÉNÉ^(ÉuÅ[ÉgÉçÅ[ÉhÇÃéüÇÃÉZÉNÉ^)Ç512ÉoÉCÉgì«Ç›çûÇﬁÅz
    47                                  	; int 0x13 : ÉZÉNÉ^ì«Ç›èoÇµ(ahÇ…ÉtÉ@ÉìÉNÉVÉáÉìÉRÅ[ÉhÇê›íËÇ∑ÇÈ)
    48                                  	;		     0x02 : ÉZÉNÉ^ì«Ç›çûÇ›
    49                                  	;		   Å@åãâ ÇCFÉrÉbÉgÇ…ê›íËÇ∑ÇÈ(0=ê¨å˜,1=é∏îs)
    50                                  	;****************************************************
    51 00000075 B402                    	mov ah,0x02			;	ì«Ç›çûÇ›ÉÇÅ[ÉhÇÉZÉNÉ^ì«Ç›çûÇ›Ç…ê›íË
    52 00000077 B001                    	mov al,1			;	ì«Ç›çûÇﬁÉZÉNÉ^êîÇ1Ç…éwíË
    53 00000079 B90200                  	mov cx,0x0002		;	ì«Ç›çûÇﬁÉZÉNÉ^Ç2î‘Ç…éwíË(é¿ç€Ç…ÉZÉNÉ^éwíËÇ…égÇ§ÇÃÇÕclÉåÉWÉXÉ^ÇÃ5ÉoÉCÉg)
    54 0000007C B600                    	mov dh,0x00			;	ÉwÉbÉhà íuÇ0Ç…éwíË
    55 0000007E 8A16[BA00]              	mov dl,[BOOT.DRIVE]	;	ÉhÉâÉCÉuî‘çÜÇéwíË
    56 00000082 BB007E                  	mov bx,0x7C00 + 512	;	ì«Ç›çûÇÒÇæÉZÉNÉ^Çäiî[Ç∑ÇÈÉoÉbÉtÉ@ÇÃêÊì™ÉAÉhÉåÉXÇéwíË(ÉuÅ[ÉgÉRÅ[ÉhÇÃéüÇ…îzíu)
    57 00000085 CD13                    	int 0x13			;	BIOSÉTÅ[ÉrÉXäÑÇËçûÇ›ÇÃì«Ç›ÇæÇµñΩóﬂÇé¿çs
    58                                  							;if(CF = BIOS(0x13,0x12))
    59 00000087 730C                    	.10Q:	jnc	.10E			;{							//	ì«Ç›çûÇ›Ç™é∏îsÇµÇΩèÍçá
    60 00000089 68[A500]E82D0083C4-     	.10T:	cdecl	puts,.e0		;	puts(.e0)
    60 00000091 02                 
    61 00000092 E84600                  		call reboot				;	reboot();	//çƒãNìÆ
    62                                  	.10E:						;}							//	ì«Ç›çûÇ›Ç™ê¨å˜ÇµÇΩèÍçá
    63                                  
    64                                  	;****************************************************
    65                                  	;éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
    66                                  	;****************************************************
    67 00000095 E96801                  	jmp stage_2					;	ÉuÅ[ÉgèàóùÇÃëÊ2ÉXÉeÅ[ÉWÇ÷
    68                                  
    69                                  ;----------------
    70                                  ;ï∂éöóÒÇÃï\é¶Ç≈ï\é¶Ç∑ÇÈÉfÅ[É^
    71                                  ;----------------
    72 00000098 426F6F74696E672E2E-     .s0	db "Booting...",0x0A,0x0D,0		;//	.s0 = "Booting..." +"0x0A(ÉâÉCÉìÉtÉBÅ[Éh)"+"0x0D(ÉLÉÉÉäÉbÉWÉäÉ^Å[Éì)";
    72 000000A1 2E0A0D00           
    73 000000A5 4572726F723A736563-     .e0	db"Error:sector read",0x0A,0x0D,0
    73 000000AE 746F7220726561640A-
    73 000000B7 0D00               
    74                                  
    75 000000B9 00                      ALIGN 2,db 0			;ÉfÅ[É^Ç2ÉoÉCÉgã´äEÇ≈îzíuÇ∑ÇÈÇÊÇ§Ç…éwé¶
    76                                  BOOT:				;ÉuÅ[ÉgÉhÉâÉCÉuÇ…ä÷Ç∑ÇÈèÓïÒ
    77 000000BA 0000                    .DRIVE:		dw 0		;ÉhÉâÉCÉuî‘çÜ
    78                                  
    79                                  ;------------------------
    80                                  ;ÅyÉÇÉWÉÖÅ[ÉãÅz
    81                                  ;------------------------
    82                                  %include "..\modules\real\puts.s"
     1                              <1> ;************************
     2                              <1> ; void puts(str)
     3                              <1> ;************************
     4                              <1> ; Êàª„ÇäÂÄ§ | „Å™„Åó
     5                              <1> ; str	 | ÊñáÂ≠óÂàó„Ç¢„Éâ„É¨„Çπ
     6                              <1> ;************************
     7                              <1> 
     8                              <1> puts:
     9                              <1> 
    10                              <1> ;------------------------
    11                              <1> ;„Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
    12                              <1> ;------------------------
    13                              <1> ; +4 	 | ÊñáÂ≠óÂàó„Å∏„ÅÆ„Ç¢„Éâ„É¨„Çπ
    14                              <1> ; +2 	 | IP(Êàª„ÇäÁï™Âú∞)
    15                              <1> ; BP + 0 | BP(ÂÖÉ„ÅÆÂÄ§)
    16                              <1> ;--------|------------
    17                              <1> 
    18 000000BC 55                  <1> push bp
    19 000000BD 89E5                <1> mov bp,sp
    20                              <1> 
    21                              <1> ;------------------------
    22                              <1> ;„Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
    23                              <1> ;------------------------
    24 000000BF 50                  <1> push ax
    25 000000C0 53                  <1> push bx
    26 000000C1 56                  <1> push si
    27                              <1> 
    28                              <1> ;------------------------
    29                              <1> ;„ÄêÂºïÊï∞„ÇíÂèñÂæó„Äë
    30                              <1> ;------------------------
    31 000000C2 8B7604              <1> mov si,[bp + 4]
    32                              <1> 
    33                              <1> ;------------------------
    34                              <1> ;„ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
    35                              <1> ;------------------------
    36 000000C5 B40E                <1> mov ah,0x0E
    37 000000C7 BB0000              <1> mov bx,0x0000
    38 000000CA FC                  <1> cld         ;DF„Éï„É©„Ç∞„Çí0„Å´Ë®≠ÂÆö„Åó„Å¶„ÄÅ[lodsbÂëΩ‰ª§„ÅÆÊôÇ„Å´]„Ç¢„Éâ„É¨„Çπ„ÇíÂä†ÁÆó
    39                              <1> 
    40                              <1> .10L:       ;do{
    41 000000CB AC                  <1> lodsb       ;   AL = *SI++;
    42 000000CC 3C00                <1> cmp al,0    ;   if(0 == AL)
    43 000000CE 7404                <1> je  .10E    ;       break;
    44 000000D0 CD10                <1> int 0x10    ;   Int10(0x0E,AL); // ÊñáÂ≠óÂá∫Âäõ
    45 000000D2 EBF7                <1> jmp .10L    ;
    46                              <1> .10E:       ;}while(1); //aaaaaaaaaaaaaaaaaaaaaaaaaaa
    47                              <1> ;------------------------
    48                              <1> ;„Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
    49                              <1> ;------------------------
    50 000000D4 5E                  <1> pop si
    51 000000D5 5B                  <1> pop bx
    52 000000D6 58                  <1> pop ax
    53                              <1> ;------------------------
    54                              <1> ;„Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
    55                              <1> ;------------------------
    56 000000D7 89EC                <1> mov sp,bp
    57 000000D9 5D                  <1> pop bp
    58                              <1> 
    59 000000DA C3                  <1> ret
    83                                  %include "..\modules\real\reboot.s"
     1                              <1> reboot:
     2                              <1> ;------------------
     3                              <1> ;„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
     4                              <1> ;------------------
     5 000000DB 68[F700]E8DBFF83C4- <1> cdecl puts, .s0
     5 000000E3 02                  <1>
     6                              <1> 
     7                              <1> ;------------------
     8                              <1> ;„Ç≠„Éº„ÅÆÂÖ•ÂäõÂæÖ„Å°
     9                              <1> ;intÂëΩ‰ª§ : Ââ≤„ÇäËæº„Åø„Éè„É≥„Éâ„É©„ÄÅ‰æãÂ§ñ„Éè„É≥„Éâ„É©„ÇíÂëº„Å≥Âá∫„Åô
    10                              <1> ;          BIOS„Å´Áî®ÊÑè„Åï„Çå„ÅüÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô„Ç§„É°„Éº„Ç∏
    11                              <1> ;------------------
    12                              <1> .10L:           ;do{
    13 000000E4 B410                <1>     mov ah,0x10 ;   „Ç≠„ÉºÂÖ•ÂäõÂæÖ„Å°
    14 000000E6 CD16                <1>     int 0x16    ;   AL = BIOS(0x16,0x10);
    15                              <1> 
    16 000000E8 3C20                <1>     cmp al,' '   ;   ZF == AL == '';//„Çπ„Éö„Éº„Çπ„ÇíÊäº„Åó„ÅüÂ†¥Âêà
    17 000000EA 75F8                <1>     jne .10L    ;}while(!ZF);
    18                              <1> 
    19                              <1> ;------------------
    20                              <1> ;ÊîπË°å„ÇíÂá∫Âäõ
    21                              <1> ;------------------
    22 000000EC 68[1501]E8CAFF83C4- <1> cdecl puts, .s1   ;   ÊîπË°å
    22 000000F4 02                  <1>
    23                              <1> 
    24                              <1> ;------------------
    25                              <1> ;ÂÜçËµ∑Âãï
    26                              <1> ;------------------
    27 000000F5 CD19                <1> int 0x19        ;   BIOS(0x19); //reboot()
    28                              <1> 
    29                              <1> ;------------------
    30                              <1> ;ÊîπË°å„ÇíÂá∫Âäõ
    31                              <1> ;------------------
    32 000000F7 0A0D50757368205350- <1> .s0 db 0x0A,0x0D,"Push SPACE key to reboot...",0
    32 00000100 414345206B65792074- <1>
    32 00000109 6F207265626F6F742E- <1>
    32 00000112 2E2E00              <1>
    33 00000115 0A0D0A0D00          <1> .s1 db 0x0A,0x0D,0x0A,0x0D,0
    84                                  
    85                                  
    86                                  ;****************************************************
    87                                  ;ÅyÉuÅ[ÉgÉtÉâÉOÅz(êÊì™512ÉoÉCÉgÇÃèIóπ)
    88                                  ;****************************************************
    89 0000011A 00<rept>                times 510 - ($ - $$) db 0x00
    90 000001FE 55AA                    db 0x55,0xAA
    91                                  
    92                                  
    93                                  ;****************************************************
    94                                  ;ÅyÉuÅ[ÉgèàóùÇÃëÊ2ÉXÉeÅ[ÉWÅz
    95                                  ;****************************************************
    96                                  stage_2:
    97                                  
    98                                  	;--------------------------
    99                                  	;ï∂éöóÒÇï\é¶
   100                                  	;--------------------------
   101 00000200 68[0B02]E8B6FE83C4-     	cdecl puts,.s0
   101 00000208 02                 
   102                                  
   103                                  
   104                                  	;----------------
   105                                  	;èàóùÇÃèIóπ
   106                                  	;----------------
   107 00000209 EBFE                    	jmp $			;while(1); // ñ≥å¿ÉãÅ[Év
   108                                  
   109                                  	;----------------
   110                                  	;ÉfÅ[É^
   111                                  	;----------------
   112 0000020B 326E64207374616765-     .s0 db "2nd stage...",0x0A,0x0D,0
   112 00000214 2E2E2E0A0D00       
   113                                  
   114                                  ;****************************************************
   115                                  ;ÉpÉfÉBÉìÉO(Ç±ÇÃÉtÉ@ÉCÉãÇÕ8KÉoÉCÉg(512 * 16)Ç∆Ç∑ÇÈ)
   116                                  ;****************************************************
   117 0000021A 00<rept>                times (1024 * 8) -($ - $$)	db 0	;8KÉoÉCÉg
